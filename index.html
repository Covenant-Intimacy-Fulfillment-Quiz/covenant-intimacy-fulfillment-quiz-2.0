<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marriage Connection Quiz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fff9f2; color: #1a3c5e; max-width: 900px; margin: auto; padding: 20px; }
    h1,h2,h3 { text-align: center; }
    .card { background: #fff; border: 2px solid #4d9de0; border-radius: 12px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); margin: 20px auto; max-width: 750px; text-align: center; }
    .btn, .answer-btn { background: #4d9de0; color: white; font-weight: bold; border: none; border-radius: 8px; padding: 12px 20px; cursor: pointer; margin: 10px 0; display: block; width: 100%; max-width: 500px; }
    .btn:hover, .answer-btn:hover { background: #3a7fbf; }
    .hidden { display:none; }
    .progress { font-weight: bold; margin: 10px 0; }
    .result-block { margin:15px 0; text-align:left; padding:15px; border-radius:8px; }
    .priority { border-left:8px solid #FF4D4D; background:#ffeaea; }
    .progress-cat { border-left:8px solid #4D9DE0; background:#e7f1fb; }
    .presence { border-left:8px solid #6c757d; background:#f2f2f2; }
    .logo { display:block; margin:0 auto 15px auto; max-width:200px; }
  </style>
</head>
<body>

<div id="introPage" class="card">
  <img src="logo.png" class="logo" alt="Logo"/>
  <h1>Discover Your Marriage Connection Profile</h1>
  <p>Answer 26 situational questions to reveal how you love, connect, and build trust in marriage.</p>
  <button class="btn" onclick="startQuiz()">Start Assessment</button>
</div>

<div id="quizPage" class="card hidden">
  <h2>Questionnaire</h2>
  <div class="progress" id="progress"></div>
  <div id="questionContainer"></div>
</div>

<div id="resultPage" class="card hidden">
  <img src="logo.png" class="logo" alt="Logo"/>
  <h2>Your Personalized Connection Profile</h2>
  <div id="results"></div>

  <div class="email-form">
    <input type="text" id="nameInput" placeholder="Your Name"/>
    <input type="email" id="emailInput" placeholder="Your Email"/>
    <button class="btn" onclick="generatePDF()">Download PDF</button>
  </div>
</div>

<script>
/* ✅ SAME 26 QUESTIONS AS BEFORE */
const questions = [/* (Insert same 26-question array from previous version) */];

let index=0,tempScores={},intimacyScores={},bondingScores={};
["Sanguine","Choleric","Melancholy","Phlegmatic","Supine"].forEach(t=>tempScores[t]=0);
["Anchored Connector","Assurance Seeker","Steady Soul","Tender Protector"].forEach(b=>bondingScores[b]=0);

const expressedTraits = {
  Sanguine:"Playful, social, uplifting, enthusiastic in expressing affection.",
  Choleric:"Action-oriented, decisive, protective, shows love through doing.",
  Melancholy:"Deep, thoughtful, loyal, values meaningful expressions of love.",
  Phlegmatic:"Calm, steady, supportive, shows love through presence and comfort.",
  Supine:"Gentle, selfless, servant-hearted, expresses love through service."
};

const desiredTraits = {
  Sanguine:"Craves affirmation, physical affection, and enthusiastic love.",
  Choleric:"Feels loved when respected, trusted, and appreciated for strength.",
  Melancholy:"Desires consistency, deep emotional connection, and loyalty.",
  Phlegmatic:"Feels safe with reliability, comfort, and steady reassurance.",
  Supine:"Longs to be pursued, noticed, and cherished with tender affection."
};

const bondingText = {
  "Anchored Connector":"Your bonding style feels valued when closeness and trust are mutual. You communicate needs openly, repair conflicts quickly, and feel safe depending on your spouse.",
  "Assurance Seeker":"Your bonding style feels valued when you receive consistent reassurance and expressions of love. Closeness and affirmation make you feel safe and secure.",
  "Steady Soul":"Your bonding style feels valued when your spouse respects your need for calm and space. You thrive with gentle connection and steady emotional safety.",
  "Tender Protector":"Your bonding style feels valued when you see proof that your spouse is trustworthy and reliable. Feeling safe, secure, and protected builds deep connection."
};

const intimacyDescriptions = {
  Spiritual:"Shared faith and values form the foundation of your bond.",
  Emotional:"You long to feel emotionally safe and deeply known.",
  Intellectual:"You enjoy connecting through thoughtful conversations.",
  Physical:"Being close through touch helps you feel safe and loved.",
  Sexual:"Sexual intimacy expresses affection, passion, and closeness.",
  Conflict:"You value staying connected even during disagreements.",
  Partnership:"You thrive when responsibilities and decisions are shared.",
  Affable:"Playfulness, kindness, and joy build your connection.",
  Creative:"Creative activities and imagination inspire closeness.",
  Financial:"Transparency with money strengthens trust and unity.",
  Recreational:"Shared fun and activities bring energy to your bond.",
  Commitment:"Loyalty and dedication provide security in the marriage."
};

const colors = {
  Spiritual:"#FF4D4D", Emotional:"#4D9DE0", Intellectual:"#1A3C5E", Physical:"#FDC57B",
  Sexual:"#92C9D6", Conflict:"#F67599", Partnership:"#D07E5F", Affable:"#A1B56C",
  Creative:"#C084FC", Financial:"#7BC1D1", Recreational:"#FFD166", Commitment:"#06D6A0"
};

function startQuiz(){ document.getElementById("introPage").classList.add("hidden"); document.getElementById("quizPage").classList.remove("hidden"); showQuestion(); }

function showQuestion(){
  const q=questions[index];
  document.getElementById("progress").textContent=`Question ${index+1} of ${questions.length}`;
  let html=`<h3>${q.q}</h3>`;
  q.opts.forEach((o,i)=> html+=`<button class="answer-btn" onclick="answer(${i})">${o.text}</button>`);
  document.getElementById("questionContainer").innerHTML=html;
}

function answer(optIndex){
  const o=questions[index].opts[optIndex];
  if(o.t) tempScores[o.t]++; 
  if(o.i) intimacyScores[o.i]=(intimacyScores[o.i]||0)+1; 
  if(o.b) bondingScores[o.b]=(bondingScores[o.b]||0)+1;
  index++; if(index<questions.length) showQuestion(); else showResults();
}

function showResults(){
  const topTemp = Object.entries(tempScores).sort((a,b)=>b[1]-a[1]);
  const topInt = Object.entries(intimacyScores).sort((a,b)=>b[1]-a[1]);
  const topBond = Object.entries(bondingScores).sort((a,b)=>b[1]-a[1])[0]?.[0];

  const priority = topInt.slice(0,4);
  const progress = topInt.slice(4,8);
  const presence = topInt.slice(8,12);

  let html = `<h3>Affection Preferences</h3>
    <div class="result-block"><strong>Expressed Affection:</strong> ${expressedTraits[topTemp[0][0]]}</div>
    <div class="result-block"><strong>Desired Affection Preference:</strong> ${desiredTraits[topTemp[0][0]]}</div>
    <h3>Your Bonding Style</h3>
    <div class="result-block">${bondingText[topBond]}</div>
    <h3>Your Intimacy Needs</h3>`;

  html += `<h4>Priority – Your Highest Intimacy Needs</h4>`;
  priority.forEach(([t])=>{
    html += `<div class="result-block priority" style="border-left:8px solid ${colors[t]}"><strong>${t}</strong><br>${intimacyDescriptions[t]}</div>`;
  });

  html += `<h4>Progress – Areas for Growth</h4>`;
  progress.forEach(([t])=>{
    html += `<div class="result-block progress-cat" style="border-left:8px solid ${colors[t]}"><strong>${t}</strong><br>${intimacyDescriptions[t]}</div>`;
  });

  html += `<h4>Presence – Often Overlooked</h4>`;
  presence.forEach(([t])=>{
    html += `<div class="result-block presence" style="border-left:8px solid ${colors[t]}"><strong>${t}</strong><br>${intimacyDescriptions[t]}</div>`;
  });

  document.getElementById("quizPage").classList.add("hidden");
  document.getElementById("resultPage").classList.remove("hidden");
  document.getElementById("results").innerHTML = html;
}

/* ✅ PDF Generator now clones this results layout */
async function generatePDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("p","pt","a4");
  const pageWidth=pdf.internal.pageSize.getWidth();
  const pageHeight=pdf.internal.pageSize.getHeight();
  const marginX=30,marginY=40,usableWidth=pageWidth-marginX*2;

  const logo=new Image(); logo.src="logo.png"; await new Promise(r=>logo.onload=r);
  pdf.addImage(logo,"PNG",pageWidth/2-90,70,180,90);
  pdf.setFont("helvetica","bold"); pdf.setFontSize(24);
  pdf.text("Your Personalized Connection Profile",pageWidth/2,200,{align:"center"});
  pdf.setFont("helvetica","normal"); pdf.setFontSize(14);
  pdf.text("Based on the Covenant Intimacy Fulfillment Model™",pageWidth/2,225,{align:"center"});

  const userName=document.getElementById("nameInput").value||"Valued User";
  const today=new Date().toLocaleDateString(undefined,{month:"long",day:"numeric",year:"numeric"});
  pdf.setFontSize(12); pdf.text(`Prepared for ${userName} – ${today}`,pageWidth/2,250,{align:"center"});

  pdf.setFont("helvetica","bold"); pdf.setFontSize(14);
  pdf.text("Discover Your Path to Deeper Connection",pageWidth/2,300,{align:"center"});
  pdf.setFont("helvetica","normal"); pdf.setFontSize(12);
  pdf.text("This profile reveals how you uniquely prioritize the 12 types of intimacy God designed for marriage. See your Priority, Progress, and Presence areas—and learn how each one can bring you and your spouse closer than ever.",pageWidth/2,330,{align:"center",maxWidth:usableWidth});
  pdf.setFont("helvetica","italic");
  pdf.text("This profile is based on the Covenant Intimacy Fulfillment Model™ (CIFM), developed through the research of Dr. Scott Inman, PhD—founder of the Happy Marriage, Happy Life™ marriage curriculum and resources.",pageWidth/2,400,{align:"center",maxWidth:usableWidth});

  pdf.setFillColor("#4D9DE0");
  pdf.rect(marginX,pageHeight-50,usableWidth,40,"F");
  pdf.setTextColor("#FFFFFF");
  pdf.setFont("helvetica","bold"); pdf.setFontSize(12);
  pdf.text("HappyMarriageHappyLife.com  |  Helping Couples Build Lasting Love",pageWidth/2,pageHeight-25,{align:"center"});

  pdf.addPage();

  const resultsClone=document.getElementById("results").cloneNode(true);
  const tempDiv=document.createElement("div");
  tempDiv.appendChild(resultsClone);
  document.body.appendChild(tempDiv);

  const canvas=await html2canvas(tempDiv,{scale:2,useCORS:true});
  document.body.removeChild(tempDiv);

  const imgData=canvas.toDataURL("image/png");
  const imgProps=pdf.getImageProperties(imgData);
  const imgHeight=(imgProps.height*usableWidth)/imgProps.width;
  pdf.addImage(imgData,"PNG",marginX,marginY,usableWidth,imgHeight);

  pdf.save("Connection-Profile.pdf");
}
<script>
let index = 0, tempScores = {}, intimacyScores = {}, bondingScores = {};
["Sanguine","Choleric","Melancholy","Phlegmatic","Supine"].forEach(t=>tempScores[t]=0);
["Anchored Connector","Assurance Seeker","Steady Soul","Tender Protector"].forEach(b=>bondingScores[b]=0);

const expressedTraits = {
  Sanguine:"Playful, social, uplifting, enthusiastic in expressing affection.",
  Choleric:"Action-oriented, decisive, protective, shows love through doing.",
  Melancholy:"Deep, thoughtful, loyal, values meaningful expressions of love.",
  Phlegmatic:"Calm, steady, supportive, shows love through presence and comfort.",
  Supine:"Gentle, selfless, servant-hearted, expresses love through service."
};
const desiredTraits = {
  Sanguine:"Craves affirmation, physical affection, and enthusiastic love.",
  Choleric:"Feels loved when respected, trusted, and appreciated for strength.",
  Melancholy:"Desires consistency, deep emotional connection, and loyalty.",
  Phlegmatic:"Feels safe with reliability, comfort, and steady reassurance.",
  Supine:"Longs to be pursued, noticed, and cherished with tender affection."
};
const bondingText = {
  "Anchored Connector":"Your bonding style feels valued when closeness and trust are mutual. You communicate needs openly, repair conflicts quickly, and feel safe depending on your spouse.",
  "Assurance Seeker":"Your bonding style feels valued when you receive consistent reassurance and expressions of love. Closeness and affirmation make you feel safe and secure.",
  "Steady Soul":"Your bonding style feels valued when your spouse respects your need for calm and space. You thrive with gentle connection and steady emotional safety.",
  "Tender Protector":"Your bonding style feels valued when you see proof that your spouse is trustworthy and reliable. Feeling safe, secure, and protected builds deep connection."
};
const intimacyDescriptions = {
  Spiritual:"Shared faith and values form the foundation of your bond.",
  Emotional:"You long to feel emotionally safe and deeply known.",
  Intellectual:"You enjoy connecting through thoughtful conversations.",
  Physical:"Being close through touch helps you feel safe and loved.",
  Sexual:"Sexual intimacy expresses affection, passion, and closeness.",
  Conflict:"You value staying connected even during disagreements.",
  Partnership:"You thrive when responsibilities and decisions are shared.",
  Affable:"Playfulness, kindness, and joy build your connection.",
  Creative:"Creative activities and imagination inspire closeness.",
  Financial:"Transparency with money strengthens trust and unity.",
  Recreational:"Shared fun and activities bring energy to your bond.",
  Commitment:"Loyalty and dedication provide security in the marriage."
};
const colors = {
  Spiritual:"#FF4D4D", Emotional:"#4D9DE0", Intellectual:"#1A3C5E", Physical:"#FDC57B",
  Sexual:"#92C9D6", Conflict:"#F67599", Partnership:"#D07E5F", Affable:"#A1B56C",
  Creative:"#C084FC", Financial:"#7BC1D1", Recreational:"#FFD166", Commitment:"#06D6A0"
};

function startQuiz(){
  document.getElementById("introPage").classList.add("hidden");
  document.getElementById("quizPage").classList.remove("hidden");
  showQuestion();
}
function showQuestion(){
  const q=questions[index];
  document.getElementById("progress").textContent=`Question ${index+1} of ${questions.length}`;
  let html=`<h3>${q.q}</h3>`;
  q.opts.forEach((o,i)=> html+=`<button class="answer-btn" onclick="answer(${i})">${o.text}</button>`);
  document.getElementById("questionContainer").innerHTML=html;
}
function answer(optIndex){
  const o=questions[index].opts[optIndex];
  if(o.t) tempScores[o.t]++; 
  if(o.i) intimacyScores[o.i]=(intimacyScores[o.i]||0)+1; 
  if(o.b) bondingScores[o.b]=(bondingScores[o.b]||0)+1;
  index++; 
  if(index<questions.length) showQuestion(); else showResults();
}

/* ---------- RESULTS PAGE + CHART ---------- */
function showResults(){
  const topTemp = Object.entries(tempScores).sort((a,b)=>b[1]-a[1]);
  const topInt = Object.entries(intimacyScores).sort((a,b)=>b[1]-a[1]);
  const topBond = Object.entries(bondingScores).sort((a,b)=>b[1]-a[1])[0]?.[0];
  const priority = topInt.slice(0,4);
  const progress = topInt.slice(4,8);
  const presence = topInt.slice(8,12);

  renderChart(topInt);

  let html = `<h3>Affection Preferences</h3>
    <div class="result-block"><strong>Expressed Affection:</strong> ${expressedTraits[topTemp[0][0]]}</div>
    <div class="result-block"><strong>Desired Affection Preference:</strong> ${desiredTraits[topTemp[0][0]]}</div>
    <h3>Your Bonding Style</h3>
    <div class="result-block">${bondingText[topBond]}</div>
    <h3>Your Intimacy Needs</h3>`;

  html += `<h4>Priority – Your Highest Intimacy Needs</h4>`;
  priority.forEach(([t])=>{
    html += `<div class="result-block priority" style="border-left:8px solid ${colors[t]}"><strong>${t}</strong><br>${intimacyDescriptions[t]}</div>`;
  });
  html += `<h4>Progress – Areas for Growth</h4>`;
  progress.forEach(([t])=>{
    html += `<div class="result-block progress-cat" style="border-left:8px solid ${colors[t]}"><strong>${t}</strong><br>${intimacyDescriptions[t]}</div>`;
  });
  html += `<h4>Presence – Often Overlooked</h4>`;
  presence.forEach(([t])=>{
    html += `<div class="result-block presence" style="border-left:8px solid ${colors[t]}"><strong>${t}</strong><br>${intimacyDescriptions[t]}</div>`;
  });

  document.getElementById("quizPage").classList.add("hidden");
  document.getElementById("resultPage").classList.remove("hidden");
  document.getElementById("results").innerHTML = html;
}

/* ---------- BAR CHART ---------- */
function renderChart(sortedScores){
  const labels = sortedScores.map(([t])=>t);
  const values = sortedScores.map(([,v])=>v);
  const bgColors = labels.map(l=>colors[l] || "#4d9de0");
  const ctx = document.getElementById("intimacyChart").getContext("2d");
  new Chart(ctx,{
    type:"bar",
    data:{labels:labels, datasets:[{label:"Intimacy Scores", data:values, backgroundColor:bgColors}]},
    options:{indexAxis:"y", plugins:{legend:{display:false}}}
  });
}

/* ---------- PDF GENERATION ---------- */
async function generatePDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("p","pt","a4");
  const pageWidth=pdf.internal.pageSize.getWidth();
  const pageHeight=pdf.internal.pageSize.getHeight();
  const marginX=30,marginY=40,usableWidth=pageWidth-marginX*2;

  const logo=new Image(); logo.src="logo.png"; await new Promise(r=>logo.onload=r);
  pdf.addImage(logo,"PNG",pageWidth/2-90,70,180,90);
  pdf.setFont("helvetica","bold"); pdf.setFontSize(24);
  pdf.text("Your Personalized Connection Profile",pageWidth/2,200,{align:"center"});
  pdf.setFont("helvetica","normal"); pdf.setFontSize(14);
  pdf.text("Based on the Covenant Intimacy Fulfillment Model™",pageWidth/2,225,{align:"center"});

  const userName=document.getElementById("nameInput").value||"Valued User";
  const userEmail=document.getElementById("emailInput").value||"";
  const today=new Date().toLocaleDateString(undefined,{month:"long",day:"numeric",year:"numeric"});
  pdf.setFontSize(12); pdf.text(`Prepared for ${userName} – ${today}`,pageWidth/2,250,{align:"center"});

  pdf.setFont("helvetica","bold"); pdf.setFontSize(14);
  pdf.text("Discover Your Path to Deeper Connection",pageWidth/2,300,{align:"center"});
  pdf.setFont("helvetica","normal"); pdf.setFontSize(12);
  pdf.text("This profile reveals how you uniquely prioritize the 12 types of intimacy God designed for marriage. See your Priority, Progress, and Presence areas—and learn how each one can bring you and your spouse closer than ever.",pageWidth/2,330,{align:"center",maxWidth:usableWidth});
  pdf.setFont("helvetica","italic");
  pdf.text("This profile is based on the Covenant Intimacy Fulfillment Model™ (CIFM), developed through the research of Dr. Scott Inman, PhD—founder of the Happy Marriage, Happy Life™ marriage curriculum and resources.",pageWidth/2,400,{align:"center",maxWidth:usableWidth});

  pdf.setFillColor("#4D9DE0");
  pdf.rect(marginX,pageHeight-50,usableWidth,40,"F");
  pdf.setTextColor("#FFFFFF");
  pdf.setFont("helvetica","bold"); pdf.setFontSize(12);
  pdf.text("HappyMarriageHappyLife.com  |  Helping Couples Build Lasting Love",pageWidth/2,pageHeight-25,{align:"center"});

  pdf.addPage();

  /* Capture chart + results as image */
  const resultsClone=document.getElementById("resultPage").cloneNode(true);
  resultsClone.querySelector(".email-form").remove();
  document.body.appendChild(resultsClone);
  const canvas=await html2canvas(resultsClone,{scale:2,useCORS:true});
  document.body.removeChild(resultsClone);

  const imgData=canvas.toDataURL("image/png");
  const imgProps=pdf.getImageProperties(imgData);
  const imgHeight=(imgProps.height*usableWidth)/imgProps.width;
  pdf.addImage(imgData,"PNG",marginX,marginY,usableWidth,imgHeight);

  /* -------- SEND EMAIL via Formspree -------- */
  await fetch("YOUR_FORMSPREE_URL_HERE", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      name:userName,
      email:userEmail,
      temperament:tempScores,
      intimacy:intimacyScores,
      bonding:bondingScores
    })
  });

  pdf.save("Connection-Profile.pdf");
  alert("✅ Results sent to your email and PDF downloaded!");
}

</script>

